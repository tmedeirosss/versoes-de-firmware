<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Firmware Canon</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --canon-red: #CC0000;
            --dark-bg: #1a1a1a;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-color: #333;
            --gray-light: #f5f5f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #2b2b2b 0%, #000000 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            padding: 20px;
        }

        .container {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            width: 100%;
            max-width: 500px;
            padding: 40px;
            overflow: hidden;
            border-top: 4px solid var(--canon-red);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            max-width: 150px;
            height: auto;
            margin-bottom: 15px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .config-area {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fff;
        }

        input[type="text"]:focus {
            border-color: var(--canon-red);
            outline: none;
            box-shadow: 0 0 0 3px rgba(204, 0, 0, 0.1);
        }

        button.btn-save {
            width: 100%;
            padding: 14px;
            background-color: var(--canon-red);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button.btn-save:hover {
            background-color: #a30000;
            transform: translateY(-2px);
        }

        button.btn-save:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .records-section {
            margin-top: 40px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }

        h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #444;
        }

        .record-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .record-item {
            background: var(--gray-light);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--canon-red);
            animation: fadeIn 0.3s ease;
        }

        .record-info {
            display: flex;
            flex-direction: column;
        }

        .record-serial {
            font-weight: 700;
            color: #000;
        }

        .record-firmware {
            font-size: 0.85rem;
            color: #666;
        }

        .record-date {
            font-size: 0.75rem;
            color: #999;
            margin-top: 4px;
        }

        .btn-delete {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            transition: color 0.2s;
        }

        .btn-delete:hover {
            color: var(--canon-red);
        }

        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scrollbar custom styling */
        .record-list::-webkit-scrollbar {
            width: 6px;
        }

        .record-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .record-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .record-list::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <img src="canon_logo.png" alt="Canon Logo" class="logo">
            <h1>Registro de Firmware</h1>
        </header>

        <!-- Config Alert -->
        <div id="configAlert" class="config-area">
            <strong>⚠️ Configuração Necessária:</strong><br>
            Edite o arquivo <code>index.html</code> e adicione suas chaves do Firebase na área marcada com "COLE SUAS
            CHAVES AQUI". Veja o arquivo <code>walkthrough.md</code> para instruções.
        </div>

        <main>
            <div class="form-group">
                <label for="serialNumber">Número de Série</label>
                <input type="text" id="serialNumber" placeholder="Ex: RRQ071234" autocomplete="off">
            </div>

            <div class="form-group">
                <label for="firmwareVersion">Versão de Firmware</label>
                <input type="text" id="firmwareVersion" placeholder="Ex: 1.0.5" autocomplete="off">
            </div>

            <button class="btn-save" id="btnSave">Salvar na Nuvem</button>
        </main>

        <section class="records-section">
            <h2>Registros na Nuvem</h2>
            <ul class="record-list" id="recordList">
                <li class="empty-state">Carregando registros...</li>
            </ul>
        </section>
    </div>

    <div id="toast" class="toast">Registro salvo com sucesso!</div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        //  COLE SUAS CHAVES DO FIREBASE AQUI ABAIXO
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBwWZoZoZoZoZoZoZoZoZoZoZoZoZoZoZo",
            authDomain: "firmwares-canon.firebaseapp.com",
            projectId: "firmwares-canon",
            storageBucket: "firmwares-canon.firebasestorage.app",
            messagingSenderId: "635926490070",
            appId: "1:635926490070:web:e3992abbbdbd2892cc9277",
            measurementId: "G-02W1FT8QWW"
        };
        // ==========================================

        let db;
        const configAlert = document.getElementById('configAlert');
        const btnSave = document.getElementById('btnSave');
        const recordList = document.getElementById('recordList');
        const serialInput = document.getElementById('serialNumber');
        const firmwareInput = document.getElementById('firmwareVersion');
        const toast = document.getElementById('toast');

        // Initialize Firebase

        // Toggle config alert
        if (firebaseConfig.apiKey === "SUA_API_KEY_AQUI") {
            btnSave.disabled = true;
            btnSave.textContent = "Configure o Firebase primeiro";
        } else {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                configAlert.style.display = 'none';
            } catch (e) {
                console.error("Erro ao iniciar Firebase:", e);
            }
        }

        // ==========================================
        //  UI Logic (LocalStorage)
        // ==========================================

        // Load records from LocalStorage on startup
        document.addEventListener('DOMContentLoaded', loadRecords);
        btnSave.addEventListener('click', saveRecord);

        // ==========================================
        //  Input Validation
        // ==========================================

        // Serial Number: Alphanumeric only + Uppercase
        serialInput.addEventListener('input', (e) => {
            let value = e.target.value;
            // Remove non-alphanumeric chars
            value = value.replace(/[^a-zA-Z0-9]/g, '');
            // Force uppercase
            e.target.value = value.toUpperCase();
        });

        // Firmware Version: Numbers + Dots only
        firmwareInput.addEventListener('input', (e) => {
            let value = e.target.value;
            // Remove anything not a number or dot
            value = value.replace(/[^0-9.]/g, '');
            e.target.value = value;
        });

        async function saveRecord() {
            const serial = serialInput.value.trim();
            const firmware = firmwareInput.value.trim();

            if (!serial || !firmware) {
                alert('Por favor, preencha ambos os campos.');
                return;
            }

            const timestamp = new Date().toLocaleString('pt-BR');
            btnSave.disabled = true;
            btnSave.textContent = "Salvando...";

            // 1. Update LocalStorage (UI View)
            const record = {
                id: Date.now(), // unique ID for UI tracking
                serial: serial,
                firmware: firmware,
                date: timestamp
            };

            let records = getRecords();
            // Check if serial exists to update or add new
            const existingIndex = records.findIndex(r => r.serial === serial);

            if (existingIndex >= 0) {
                // Update existing
                records[existingIndex].firmware = firmware;
                records[existingIndex].date = timestamp;
                // Optional: Move to top to show it's recent
                const updatedRecord = records.splice(existingIndex, 1)[0];
                records.unshift(updatedRecord);
            } else {
                // Add new
                records.unshift(record);
            }

            saveRecordsToStorage(records);
            renderRecords();

            // 2. Save to Firebase (Backend Archive)
            // This is "Fire and Forget" or "Wait and Notify"
            // The user wants the backend to be updated (Upsert)
            if (db) {
                try {
                    await setDoc(doc(db, "firmwares", serial), {
                        serial: serial,
                        firmware: firmware,
                        date: timestamp,
                        lastUpdated: Date.now()
                    }, { merge: true });
                    showToast('Salvo Localmente e na Nuvem!');
                } catch (error) {
                    console.error("Erro ao salvar na nuvem: ", error);
                    showToast('Salvo Apenas Localmente (Erro na Nuvem)');
                }
            } else {
                showToast('Salvo Localmente (Nuvem não configurada)');
            }

            clearInputs();
            btnSave.disabled = false;
            btnSave.textContent = "Salvar na Nuvem";
        }

        function getRecords() {
            const records = localStorage.getItem('canon_firmware_logs');
            return records ? JSON.parse(records) : [];
        }

        function saveRecordsToStorage(records) {
            localStorage.setItem('canon_firmware_logs', JSON.stringify(records));
        }

        function renderRecords() {
            const records = getRecords();
            recordList.innerHTML = '';

            if (records.length === 0) {
                recordList.innerHTML = '<li class="empty-state">Nenhum registro recente no navegador.</li>';
                return;
            }

            records.forEach(record => {
                const li = document.createElement('li');
                li.className = 'record-item';
                li.innerHTML = `
                    <div class="record-info">
                        <span class="record-serial">S/N: ${escapeHtml(record.serial)}</span>
                        <span class="record-firmware">Firmware: ${escapeHtml(record.firmware)}</span>
                        <span class="record-date">${record.date}</span>
                    </div>
                    <button class="btn-delete" title="Remover da lista">&times;</button>
                `;

                // Click listener for delete
                // Uses closure to capture the specific record ID from this render cycle
                li.querySelector('.btn-delete').addEventListener('click', () => deleteRecord(record.id));

                recordList.appendChild(li);
            });
        }

        function loadRecords() {
            renderRecords();
        }

        function deleteRecord(id) {
            // Visual Delete Only (Removes from LocalStorage, keeps in Firebase)
            if (confirm('Remover este item da lista? (O registro permanecerá salvo na nuvem)')) {
                let records = getRecords();
                records = records.filter(r => r.id !== id);
                saveRecordsToStorage(records);
                renderRecords();
            }
        }

        function clearInputs() {
            serialInput.value = '';
            firmwareInput.value = '';
            serialInput.focus();
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, function (m) { return map[m]; });
        }
    </script>
</body>

</html>